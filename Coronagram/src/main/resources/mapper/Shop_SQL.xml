<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="shop">

	<select id="getProdList" parameterType="hashmap" resultType="hashmap">
		SELECT PROD_NO,REG_NO,CAT_NO,PROD_NM,POINT,CON,SALE_STAT,PROD_DT,DEL
		FROM PRODUCT
		WHERE 1=1
	</select>
	<select id="getProd" parameterType="hashmap" resultType="hashmap">
		SELECT PROD_NO,REG_NO,CAT_NO,PROD_NM,POINT,CON,SALE_STAT,PROD_DT,DEL
		FROM PRODUCT
		WHERE PROD_NO = #{prodNo}
	</select>
	<select id="getOptList" parameterType="hashmap" resultType="hashmap" >
		SELECT OPT_NO, PROD_NO, PRICE, UNIT
		FROM PROD_OPT
		WHERE PROD_NO =#{prodNo}
	</select>
	<select id="getProdImgList" parameterType="hashmap" resultType="hashmap">
		SELECT ATTC_NO,PROD_NO,FILE_ADDR
		FROM PROD_ATTC
		WHERE PROD_NO = #{prodNo}
	</select>
	<insert id="addCart" parameterType="hashmap">
		INSERT INTO CART(CART_NO, PROD_NO, M_NO, OPT_NO)
		SELECT CART_SEQ.NEXTVAL,#{prodNo},#{sMNo},OPT_NO
		FROM PROD_OPT
		WHERE PROD_NO= #{prodNo} AND PRICE = #{price} AND UNIT=#{unit}
	</insert>
	<select id="getCartList" parameterType="hashmap" resultType="hashmap">
		SELECT C.CART_NO, C.M_NO,C.OPT_NO,O.PRICE,O.UNIT,P.CON,P.PROD_NM,P.POINT,PA.FILE_ADDR,P.PROD_NO
		FROM CART C 
		JOIN PRODUCT P
		    ON C.PROD_NO = P.PROD_NO
		JOIN PROD_OPT O
		    ON C.OPT_NO = O.OPT_NO
        JOIN (  SELECT PROD_NO,FILE_ADDR,RANK() OVER(PARTITION BY PROD_NO ORDER BY ATTC_NO ASC) AS RNK
                FROM PROD_ATTC) PA
            ON C.PROD_NO = PA.PROD_NO
            AND RNK = 1
		WHERE C.M_NO = #{sMNo}
	</select>
	<select id="getCartCnt" parameterType="hashmap" resultType="hashmap">
		SELECT COUNT(C.PROD_NO) AS CNT ,SUM(P.POINT) AS SUM,SUM(M.POINT) AS POINT
		FROM CART C
		JOIN PRODUCT P
		    ON C.PROD_NO= P.PROD_NO
        INNER JOIN M M
        ON M.M_NO = C.M_NO
		WHERE C.M_NO = 6
	</select>
	<delete id="cartDel" parameterType="Integer" >
		DELETE
		FROM CART
		WHERE CART_NO = #{cartList}
	</delete>
	<insert id="addOrder" parameterType="hashmap">
		INSERT INTO ORD (ORD_NO,USER_NO,ORD_STAT,POST_NO,ADR,DTL_ADR)
		VALUES (ORD_SEQ.NEXTVAL,#{sMNo},1,#{postNo},#{adr},#{dtlAdr})
	</insert>
	<select id="getOrd" parameterType="hashmap" resultType="Integer">
		SELECT O.ORD_NO as ORD_NO
		FROM (SELECT ORD_NO,USER_NO,RANK() OVER(PARTITION BY USER_NO ORDER BY ORD_DT DESC) RNK
        		FROM ORD) O
    		  WHERE USER_NO = #{sMNo}
   		AND RNK= 1;
	</select>
	<insert id="addOrdP" parameterType="hashmap">
		INSERT INTO ORDER_PROD(ORDER_NO,PROD_NO,OPT_NO,QTY)
		VALUES(#{ono},#{pno},#{ono},#{qt})
	</insert>
</mapper>