<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="userPage">
	<select id="getMPostList" parameterType="hashmap" resultType="hashmap">
		 <![CDATA[
		 	SELECT M.M_NO, C.WRITING_NO, CA.FILE_ADR, M.NICK_NM, C.CON, C.DT, C.DEL, NVL(L.LCNT, 0) AS LCNT, NVL(CC.CCNT, 0) AS CCNT,NVL(CW.WCNT,0) AS WCNT, 
       		ROW_NUMBER() OVER(ORDER BY C.WRITING_NO DESC) AS RNUM
			FROM CRNG C INNER JOIN M M
                    ON C.WRITER_NO = M.M_NO
                    AND M.NICK_NM = #{nickNm}
            INNER JOIN (SELECT WRITING_NO, FILE_ADR,
                               RANK() OVER(PARTITION BY WRITING_NO ORDER BY ATTC_NO ASC) AS RNK
                        FROM CRNG_ATTC) CA
                    ON C.WRITING_NO = CA.WRITING_NO
                   AND CA.RNK = 1
            left outer JOIN (SELECT WRITING_NO,NVL(count(*),0) AS WCNT
                        FROM CRNG_ATTC group by WRITING_NO) CW
                    ON C.WRITING_NO = CW.WRITING_NO
             LEFT OUTER JOIN (SELECT WRITING_NO, NVL(COUNT(*),0) AS CCNT
                             FROM CRNG_CMT
                             GROUP BY WRITING_NO) CC
                         ON C.WRITING_NO = CC.WRITING_NO 
            LEFT OUTER JOIN (SELECT WRITING_NO, NVL(COUNT(*),0) AS LCNT
                             FROM LK
                             GROUP BY WRITING_NO) L
                         ON C.WRITING_NO = L.WRITING_NO
			WHERE C.DEL = 1
		 ]]>
	</select>
	<select id="getModalCmt" parameterType="hashmap" resultType="hashmap">
			select cc.CMT_WRITER_NO,CC.WRITING_NO,cc.cmt_con,m.M_NO, m.m_nm, m.nick_nm,M.IMG_ADR
	            ,TO_CHAR(cc.dt, 'YYYY/MM/DD HH24:MI:SS') as dt,
	            ROW_NUMBER() OVER(ORDER BY cc.WRITING_NO DESC) AS RNUM
	            from crng_cmt cc
	            INNER JOIN M M
	                    ON cc.CMT_WRITER_NO = m.m_no
                        where CC.WRITING_NO= #{writingNo}
                ORDER BY RNUM DESC
	</select>
	<select id="getModalM" parameterType="hashmap" resultType="hashmap">
		 select C.WRITER_NO, C.CON, M.M_NM, M.IMG_ADR, M.NICK_NM
            from CRNG C
            INNER JOIN M M
                        ON C.WRITER_NO = M_NO
     
            where del=1 
            and m.NICK_NM=#{nickNm}
            and C.writing_no = #{writingNo}
	</select>
	<select id="getLkCnt" parameterType="hashmap" resultType="Integer">
		select NVL(count(*),0) AS lkcnt from lk where WRITING_NO = #{writingNo}
	</select>
	<select id="getIntroM" parameterType="hashmap" resultType="hashmap">
		SELECT M_NO, IMG_ADR, M_NM, NICK_NM, INTRO_CON 
        FROM M
        WHERE NICK_NM = #{nickNm}
	</select>
	<select id="getFollow" parameterType="hashmap" resultType="Integer">
		select NVL(count(*),0) fo from follow 
   		where rp_user = (select m_no from m where nick_nm=#{nickNm})
	</select>
	<select id="getFollowing" parameterType="hashmap" resultType="Integer">
		select NVL(count(*),0) fi from follow 
   		where rq_user = (select m_no from m where nick_nm=#{nickNm})
	</select>
	
	<select id="getMDtlList" parameterType="hashmap" resultType="hashmap">
		SELECT M.M_NO, C.WRITING_NO, CA.FILE_ADR, M.NICK_NM, C.CON, C.DT, C.DEL, 
        ROW_NUMBER() OVER(ORDER BY C.WRITING_NO DESC) AS RNUM
		FROM CRNG C INNER JOIN M M
                    ON C.WRITER_NO = M.M_NO
                    AND M.M_NO =(select m_no from m where nick_nm=#{nickNm})
            INNER JOIN (SELECT WRITING_NO, FILE_ADR
                        FROM CRNG_ATTC) CA
                    	ON C.WRITING_NO = CA.WRITING_NO
                    	AND ca.writing_no= #{writingNo}
			WHERE C.DEL = 1
	</select>
	
	<select id="getHeartCnt" parameterType="hashmap" resultType="Integer">
		select nvl(count(*),0) as hc from lk where user_no =#{m_no} and writing_no = #{writingNo}
	</select>
	<select id="getfollowEx" parameterType="hashmap" resultType="Integer">
		SELECT  nvl(count(*),0) as fExist FROM FOLLOW WHERE RQ_USER = #{m_no} 
            and RP_USER = (SELECT M_NO FROM M WHERE NICK_NM=#{nickNm})
	</select>
	<select id="getfollowEx2" parameterType="hashmap" resultType="Integer">
		SELECT  nvl(count(*),0) as fExist2 FROM M WHERE M_NO= #{m_no} AND NICK_NM =#{nickNm}
	</select>
	<delete id="delHeart" parameterType="hashmap">
		delete from lk where user_no =#{m_no} and writing_no= #{writingNo}
	</delete>
	<insert id="addHeart" parameterType="hashmap">
		insert into lk(user_no,writing_no) values ( #{m_no}, #{writingNo} )
	</insert>
    
    <insert id="addFollow" parameterType="hashmap">
		insert into FOLLOW(RQ_USER,RP_USER) 
		select #{m_no}, m_no from m where nick_nm = #{nickNm}
	</insert>
	<delete id="delFollow" parameterType="hashmap">
		 DELETE FROM FOLLOW 
		 WHERE RQ_USER= #{m_no}
         AND RP_USER = (SELECT M_NO FROM M WHERE NICK_NM = #{nickNm})
	</delete>
	<insert id="addMCmt" parameterType="hashmap">
		insert into crng_cmt(WRITING_NO, CMT_WRITER_NO, CMT_CON)
            values(#{writingNo},#{m_no},#{cmt_con})
	</insert>      

</mapper>