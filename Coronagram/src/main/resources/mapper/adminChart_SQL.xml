<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="chart">

<select id="getGradeData" resultType ="hashmap">
SELECT COUNT(CASE WHEN ACCT_TYPE_NO=6 THEN 1 END) ADMIN
     , COUNT(CASE WHEN ACCT_TYPE_NO=5 THEN 1 END) DIAMOND
     , COUNT(CASE WHEN ACCT_TYPE_NO=4 THEN 1 END) PLATINUM
     , COUNT(CASE WHEN ACCT_TYPE_NO=3 THEN 1 END) GOLD
     , COUNT(CASE WHEN ACCT_TYPE_NO=2 THEN 1 END) SILVER
     , COUNT(CASE WHEN ACCT_TYPE_NO=1 THEN 1 END) BRONZE
  FROM M
</select>

<select id="getWeekData" resultType = "hashmap">
SELECT 
	   COUNT(CASE WHEN TO_CHAR(M_DT,'YYYY-MM-DD')=TO_CHAR(SYSDATE-6,'YYYY-MM-DD') THEN 1 END) AS "6DAYS_AGO"
     , COUNT(CASE WHEN TO_CHAR(M_DT,'YYYY-MM-DD')=TO_CHAR(SYSDATE-5,'YYYY-MM-DD') THEN 1 END) AS "5DAYS_AGO"
     , COUNT(CASE WHEN TO_CHAR(M_DT,'YYYY-MM-DD')=TO_CHAR(SYSDATE-4,'YYYY-MM-DD') THEN 1 END) AS "4DAYS_AGO"
     , COUNT(CASE WHEN TO_CHAR(M_DT,'YYYY-MM-DD')=TO_CHAR(SYSDATE-3,'YYYY-MM-DD') THEN 1 END) AS "3DAYS_AGO"
     , COUNT(CASE WHEN TO_CHAR(M_DT,'YYYY-MM-DD')=TO_CHAR(SYSDATE-2,'YYYY-MM-DD') THEN 1 END) AS "2DAYS_AGO"
     , COUNT(CASE WHEN TO_CHAR(M_DT,'YYYY-MM-DD')=TO_CHAR(SYSDATE-1,'YYYY-MM-DD') THEN 1 END) AS "1DAYS_AGO"
     , COUNT(CASE WHEN TO_CHAR(M_DT,'YYYY-MM-DD')=TO_CHAR(SYSDATE,'YYYY-MM-DD') THEN 1 END) AS   "TODAY"
FROM M
</select>

<select id="getAgeData" resultType = "hashmap">
SELECT 
	   COUNT(CASE WHEN <![CDATA[(TO_CHAR(SYSDATE, 'YYYY')- TO_CHAR(M_BDT,'YYYY') >= 10 AND(TO_CHAR(SYSDATE, 'YYYY') - TO_CHAR(M_BDT,'YYYY')) <= 19)]]> THEN 1 END) AGE10
     , COUNT(CASE WHEN <![CDATA[(TO_CHAR(SYSDATE, 'YYYY')- TO_CHAR(M_BDT,'YYYY') >= 20 AND(TO_CHAR(SYSDATE, 'YYYY') - TO_CHAR(M_BDT,'YYYY')) <= 29)]]> THEN 1 END) AGE20
     , COUNT(CASE WHEN <![CDATA[(TO_CHAR(SYSDATE, 'YYYY')- TO_CHAR(M_BDT,'YYYY') >= 30 AND(TO_CHAR(SYSDATE, 'YYYY') - TO_CHAR(M_BDT,'YYYY')) <= 39)]]> THEN 1 END) AGE30
     , COUNT(CASE WHEN <![CDATA[(TO_CHAR(SYSDATE, 'YYYY')- TO_CHAR(M_BDT,'YYYY') >= 40 AND(TO_CHAR(SYSDATE, 'YYYY') - TO_CHAR(M_BDT,'YYYY')) <= 49)]]> THEN 1 END) AGE40
     , COUNT(CASE WHEN <![CDATA[(TO_CHAR(SYSDATE, 'YYYY')- TO_CHAR(M_BDT,'YYYY') >= 50 AND(TO_CHAR(SYSDATE, 'YYYY') - TO_CHAR(M_BDT,'YYYY')) <= 59)]]> THEN 1 END) AGE50
     , COUNT(CASE WHEN <![CDATA[(TO_CHAR(SYSDATE, 'YYYY')- TO_CHAR(M_BDT,'YYYY') >= 60)]]> THEN 1 END) OAGE60
FROM M
</select>

<select id="getJoinData" resultType = "hashmap">
SELECT M1.CNT, ROUND(CCM.A,2) AS AVGCNT, M1.DT, ROW_NUMBER() OVER(ORDER BY M1.DT DESC) PERIOD
FROM (select count(*) AS CNT, to_char(m_dt,'yyyy-mm') AS DT
        from m
        group by to_char(m_dt,'yyyy-mm') )M1
INNER JOIN (SELECT AVG(CM.CNT) AS A,CM.DT
            FROM (SELECT COUNT(*) AS CNT,TO_CHAR(M_DT,'YYYY-MM') AS DT
                    FROM M
                    GROUP BY M_DT) CM
            GROUP BY CM.DT) CCM
ON M1.DT = CCM.DT
WHERE ROWNUM BETWEEN 1 AND 12
ORDER BY M1.DT
</select>

<select id="getSellData" resultType = "hashmap">
SELECT P.PROD_NO,P.PROD_NM, CNT , RNK
      FROM PRODUCT P
          INNER JOIN (SELECT PROD_NO,RANK()OVER (ORDER BY CNT DESC) AS RNK,CNT
                      FROM (SELECT PROD_NO,COUNT(*) AS CNT
                            FROM ORDER_PROD
                            GROUP BY PROD_NO) OP) ROP
          ON P.PROD_NO = ROP.PROD_NO
      <![CDATA[WHERE ROP.RNK <= 5]]>
</select>
</mapper>